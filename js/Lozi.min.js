var Lozi={Libraries:{Three:{Geometry:{generateGeometry:function(e,t,r,a,s){for(var n={name:"",vertices:[],normals:[],uvs:[]},o=0;o<s.length;o++){var i=parseInt(s[o]),c=3*(i>=0?i-1:i+t.length/3),g=3*(i>=0?i-1:i+r.length/3);n.vertices.push(t[c],t[c+1],t[c+2]),n.normals.push(r[g],r[g+1],r[g+2])}for(var p=0;p<a.length;p++){n.uvs.push([]);for(var h=0;h<s.length;h++){var i=parseInt(s[h]),l=2*(i>=0?i-1:i+a[p].length/2);n.uvs[p].push(a[p][l],a[p][l+1])}}return n.name=e,n},generateSkinData:function(e,t){for(var r=4,a=[],s=[],n=0;n<t.geometry.faces.length;n++){var o=parseInt(t.geometry.faces[n]),i=4*(o>=0?o-1:o+t.skin.skinWeights.length/4),c=4*(o>=0?o-1:o+s.length/4);a.push(t.skin.skinWeights[i],t.skin.skinWeights[i+1],t.skin.skinWeights[i+2],t.skin.skinWeights[i+3]),s.push(t.skin.skinIndices[c],t.skin.skinIndices[c+1],t.skin.skinIndices[c+2],t.skin.skinIndices[c+3])}if(a&&a.length>0)for(var g=0,p=a.length;p>g;g+=r){var h=a[g],l=void 0!==a[g+1]?a[g+1]:0,m=void 0!==a[g+2]?a[g+2]:0,u=void 0!==a[g+3]?a[g+3]:0;e.skinWeights.push(new THREE.Vector4(h,l,m,u))}if(s&&s.length>0)for(var g=0,p=s.length;p>g;g+=r){var d=s[g],f=r>1?s[g+1]:0,y=r>2?s[g+2]:0,b=r>3?s[g+3]:0;e.skinIndices.push(new THREE.Vector4(d,f,y,b))}return e.bones=t.skin.bones,e},generateBlendShapeData:function(e,t){for(var r=t.morph.blendShapes,a=0;a<r.length;a++){e.morphTargets[a]={},e.morphTargets[a].name=r[a].name,e.morphTargets[a].vertices=[];for(var s=r[a],n=this.generateGeometry(s.name,s.vertices,t.geometry.normals,t.geometry.uv,t.geometry.faces),o=0;o<n.vertices.length;o+=3){var i=new THREE.Vector3(n.vertices[o],n.vertices[o+1],n.vertices[o+2]);e.morphTargets[a].vertices.push(i)}}return e},generateMeshGeometry:function(e){var t;if(e.geometry){var r=this.generateGeometry(e.name,e.geometry.vertices,e.geometry.normals,e.geometry.uv,e.geometry.faces);if(t=new THREE.BufferGeometry,t.addAttribute("position",new THREE.BufferAttribute(new Float32Array(r.vertices),3)),r.normals.length>0&&t.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(r.normals),3)),r.uvs.length>0)for(var a=0;a<r.uvs.length;a++){var s=a>0?a+1:"";t.addAttribute("uv"+s,new THREE.BufferAttribute(new Float32Array(r.uvs[a]),2))}}return t.hasSkin=!1,t.hasMorph=!1,(e.skin||e.morph)&&(t=(new THREE.Geometry).fromBufferGeometry(t),e.skin&&(t.hasSkin=!0,t=this.generateSkinData(t,e)),e.morph&&(t.hasMorph=!0,t=this.generateBlendShapeData(t,e))),e.id&&(t.meshID=e.id),e.geometry.castShadows&&(t.castShadow=e.geometry.castShadows),e.geometry.recieveShadows&&(t.receiveShadow=e.geometry.recieveShadows),t},createMeshByGeometryID:function(e,t,r){var a,s=Lozi.Material.getMaterialByID(t,r),n=Lozi.Geometry.getGeometryByID(e,r);return n&&s&&(0==n.hasMorph&&0==n.hasSkin?a=new THREE.Mesh(n,s):(a=new THREE.SkinnedMesh(n,s),s.skinning=n.hasSkin,s.morphTargets=n.hasMorph),n.recieveShadows&&(a.receiveShadow=n.receiveShadow),n.castShadows&&(a.castShadow=n.castShadow)),a}},Material:{generateMaterial:function(e,t){var r;switch(e.type){case 0:r=new THREE.MeshStandardMaterial;break;case 1:r=new THREE.MeshBasicMaterial;break;case 2:r=new THREE.MeshPhongMaterial;break;case 3:r=new THREE.MeshLambertMaterial}return r?(r.matId=e.id,r.name=e.name,e.properties&&(e.properties._Color&&(r.color=new THREE.Color(e.properties._Color[0],e.properties._Color[1],e.properties._Color[2])),e.properties._Metallic&&(r.metalness=e.properties._Metallic),e.properties._EmissionColor&&(r.emissive=new THREE.Color(e.properties._EmissionColor[0],e.properties._EmissionColor[1],e.properties._EmissionColor[2])),e.properties._MainTex&&(r.map=Lozi.Texture.getTextureByID(e.properties._MainTex,t)),e.properties._BumpMap&&(r.bumpMap=Lozi.Texture.getTextureByID(e.properties._BumpMap,t),r.bumpMapScale=1),e.properties._BumpScale&&(r.bumpMapScale=e.properties._BumpScale),e.properties._Cube&&(r.envMap=Lozi.Texture.getTextureByID(e.properties._Cube,t)),e.properties._ReflectColor&&(r.envMapIntensity=e.properties._ReflectColor[3]),e.properties.transparentMap&&(r.transparent=!0,r.alphaMap=Lozi.Texture.getTextureByID(e.properties.transparentMap,t)),e.properties.lightMap&&(r.lightMap=Lozi.Texture.getTextureByID(e.properties.lightMap,t),r.emissiveMap=r.lightMap)),r):void 0}},Texture:{generateTexture:function(e){if(e&&e.textureData&&e.textureData.length>0&&e.textureData[0]){var t=Lozi.Texture.loadImage(e.textureData[0]),r=new THREE.Texture;return r.texID=e.id,r.name=e.name,r.image=t,r.usedImages=[r.image],r.image.onload=function(){r.needsUpdate=!0},r}},generateCubeTexture:function(e){if(e&&e.textureData&&e.textureData.length>0){var t=new THREE.CubeTexture;t.texID=e.id,t.name=e.name,t.images=[],t.usedImages=t.images;for(var r=0;r<e.textureData.length;r++)t.images.push(Lozi.Texture.loadImage(e.textureData[r])),t.images[r].onload=function(e){t.needsUpdate=!0};return t}}},Animation:{generateSkinAnimationClip:function(e,t,r){if(e&&t&&r&&r&&r.length>0){if(e.hierarchy){for(var a=[],s=0;s<r.length;s++)a.push({});for(var n=0;n<e.hierarchy.length;n++){var o=e.hierarchy[n];if(o.keys)for(var i=0;i<o.keys.length;i++)o.keys[i]=o.keys[i];a[e.hierarchy[n].index]=o}}e.hierarchy=a;var c=THREE.AnimationClip.parseAnimation(e,r);if(c)return t.animations||(t.animations=[]),t.animations.push(c),c}}},Light:{setLightData:function(e,t){e.color=new THREE.Color(t.color[0],t.color[1],t.color[2]),e.intensity=t.intensity,e.distance=t.range,e.angle=Lozi.Math.radians(t.angle),e.castShadow=t.shadow}},Camera:{setCameraData:function(e,t){e.fov=-t.fov,e.near=t.near,e.far=t.far,e.left=t.orthoSize,e.right=t.orthoSize,e.top=t.orthoSize,e.bottom=t.orthoSize,e.updateProjectionMatrix()}},Object:{classByType:function(e){switch(e){case Lozi.Object.types.Mesh:type=THREE.Mesh;break;case Lozi.Object.types.SkinnedMesh:type=THREE.SkinnedMesh;break;case Lozi.Object.types.OrthographicCamera:type=THREE.PerspectiveCamera;break;case Lozi.Object.types.PerspectiveCamera:type=THREE.PerspectiveCamera;break;case Lozi.Object.types.AreaLight:type=THREE.AmbientLight;break;case Lozi.Object.types.PointLight:type=THREE.PointLight;break;case Lozi.Object.types.DirectionalLight:type=THREE.DirectionalLight;break;case Lozi.Object.types.SpotLight:type=THREE.SpotLight;break;case Lozi.Object.types.Object:case Lozi.Object.types.AnimationObject:case Lozi.Object.types.Object3D:type=THREE.Object3D;break;case Lozi.Object.types.Scene:type=THREE.Scene}return type}}}},Geometry:{generateMeshGeometry:function(e){return Lozi.libraryObject().Geometry.generateMeshGeometry(e)},parseGeometries:function(e){var t=[];if(e)for(var r=0;r<e.length;r++)e[r]&&t.push(this.generateMeshGeometry(e[r]));return t},getGeometryByID:function(e,t){if(t.generatedAssets.geometries&&t.generatedAssets.geometries.length>0)for(var r=0;r<t.generatedAssets.geometries.length;r++)if(t.generatedAssets.geometries[r].meshID==e)return t.generatedAssets.geometries[r];return null},createMeshByGeometryID:function(e,t,r){return Lozi.libraryObject().Geometry.createMeshByGeometryID(e,t,r)}},Material:{generateMaterial:function(e,t){return Lozi.libraryObject().Material.generateMaterial(e,t)},generateMaterials:function(e,t){for(var r=[],a=0;a<e.length;a++){var s=this.generateMaterial(e[a],t);s&&r.push(s)}return r},getMaterialByID:function(e,t){if(t.generatedAssets&&t.generatedAssets.materials)for(var r=0;r<t.generatedAssets.materials.length;r++)if(t.generatedAssets.materials[r].matId==e)return t.generatedAssets.materials[r]}},Texture:{loadImage:function(e){Image.onProgress||(Image.prototype.onProgress=function(){},Image.prototype.onLoaded=function(){},Image.prototype.check=function(){this.isBase64&&(this.onProgress&&this.onProgress(this),this.onLoaded&&this.onLoaded())},Image.prototype.load=function(e){var t=this,r=new XMLHttpRequest;t.isBase64=!1,r.onload=function(e){var r=new Blob([this.response]);t.src=window.URL.createObjectURL(r),t.onLoaded&&t.onLoaded()},r.onprogress=function(e){t.completedPercentage=e.loaded/e.total,t.completedPercentage<0&&(t.completedPercentage=1),t.onProgress&&t.onProgress(t)},r.onloadstart=function(){t.completedPercentage=0},e.indexOf("data:image/png;base64,")>-1?(t.src=e,t.completedPercentage=1,t.isBase64=!0):(r.open("GET",e,!0),r.responseType="arraybuffer",r.send())});var t=new Image;return t.load(e),t},loadTexture:function(e){if(e&&e.textureData&&e.textureData.length>0){var t;switch(e.textureData.length){case 1:t=Lozi.libraryObject().Texture.generateTexture(e);break;case 6:t=Lozi.libraryObject().Texture.generateCubeTexture(e)}return t}},loadTextures:function(e,t,r){for(var a=[],s=0;s<e.length;s++){var n=this.loadTexture(e[s]);n&&a.push(n)}return a},getTextureImages:function(e,t,r){for(var a=[],s=0;s<e.length;s++)for(var n=0;n<e[s].usedImages.length;n++)e[s].usedImages[n].onLoaded=r,e[s].usedImages[n].onProgress=t,a.push(e[s].usedImages[n]);return a},getTextureByID:function(e,t){if(t.generatedAssets&&t.generatedAssets.textures)for(var r=0;r<t.generatedAssets.textures.length;r++)if(t.generatedAssets.textures[r].texID==e)return t.generatedAssets.textures[r]}},Animation:{generateSkinAnimationClip:function(e,t,r){return Lozi.libraryObject().Animation.generateSkinAnimationClip(e,t,r)}},Light:{setLightData:function(e,t){Lozi.libraryObject().Light.setLightData(e,t)}},Camera:{setCameraData:function(e,t){Lozi.libraryObject().Camera.setCameraData(e,t)}},Object:{types:{None:0,Scene:1,Object3D:2,AnimationObject:3,Object:4,Bone:5,SpotLight:6,DirectionalLight:7,PointLight:8,AreaLight:9,PerspectiveCamera:10,OrthographicCamera:11,SkinnedMesh:12,Mesh:13},getObjectByProperty:function(e,t,r){if(e&&e.length>0)for(var a=0;a<e.length;a++)if(e[a][t]&&e[a][t]==r)return e[a];return null},generateLoziObject:function(e){var t=this.objectByType(e),r=LoziObject;if(t){var a;(e.objects.type==Lozi.Object.types.Mesh||e.objects.type==Lozi.Object.types.SkinnedMesh||e.objects.meshID)&&(a=this.generateObject(e.objects,e),t=this.classByType(Lozi.Object.types.Object3D)),r=this.extend(t,LoziObject);var s=new r(e,t);return a&&s.add(a),setTimeout(function(){e.objects.flip&&s.flip(e.objects.flip[0]&&e.objects.flip[0]<0?!0:!1,e.objects.flip[1]&&e.objects.flip[1]<0?!0:!1,e.objects.flip[2]&&e.objects.flip[2]<0?!0:!1)},10),s}},generateObject:function(e,t){var r;if((e.type==Lozi.Object.types.SkinnedMesh||e.type==Lozi.Object.types.Mesh||e.meshID)&&(r=Lozi.Geometry.createMeshByGeometryID(e.meshID,e.materialID,t)),!r){var a=this.classByType(e.type);a&&e.type!=Lozi.Object.types.SkinnedMesh&&e.type!=Lozi.Object.types.Mesh&&(r=new a)}return r},classByType:function(e){return Lozi.libraryObject().Object.classByType(e)},objectByType:function(e){var t;return e&&e.objects&&(t=Lozi.Object.classByType(e.objects.type)),t},extend:function(e,t){return t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t}},libraryObject:function(){return THREE?Lozi.Libraries.Three:void console.error("NO WEBGL LIBRARY INCLUDED!")},Math:{radians:function(e){return e*Math.PI/180},degrees:function(e){return 180*e/Math.PI}},loadFromData:function(e,t,r){if(e){var a=function(r){if(e.generatedAssets.images){for(var a=0,s=0;s<e.generatedAssets.images.length;s++)a+=e.generatedAssets.images[s].completedPercentage;t&&t(a/e.generatedAssets.images.length)}},s=function(t){for(var a=!0,s=0;s<e.generatedAssets.images.length;s++)e.generatedAssets.images[s].completedPercentage<1&&(a=!1);1==a&&r&&r({data:e,object:Lozi.Object.generateLoziObject(e)})};if(e.generatedAssets=e.generatedAssets?e.generatedAssets:{},e.assets&&e.assets.meshes&&e.assets.meshes.length>0&&(e.generatedAssets.geometries=Lozi.Geometry.parseGeometries(e.assets.meshes)),e.assets&&e.assets.textures&&e.assets.textures.length>0&&(e.generatedAssets.textures=Lozi.Texture.loadTextures(e.assets.textures),e.generatedAssets.images=Lozi.Texture.getTextureImages(e.generatedAssets.textures,a,s)),e.assets&&e.assets.materials&&e.assets.materials.length>0&&(e.generatedAssets.materials=Lozi.Material.generateMaterials(e.assets.materials,e)),e.generatedAssets.images)for(var n=0;n<e.generatedAssets.images.length;n++)e.generatedAssets.images[n].check();(!e.generatedAssets.images||e.generatedAssets.images&&0==e.generatedAssets.images.length)&&(t&&t(1),r&&r({data:e,object:Lozi.Object.generateLoziObject(e)}))}},loadFromString:function(e,t,r){return Lozi.loadFromData(JSON.parse(e),t,r)},load:function(e,t,r,a){var s={totalProgress:0,dataProgress:0,textureProgress:0},n=function(){s.totalProgress=s.dataProgress/2+s.textureProgress/2,r&&r(s)},o=new XMLHttpRequest;o.onload=function(e){4==o.readyState&&200==o.status?Lozi.loadFromString(o.responseText,function(e){s.textureProgress=e,n()},t):a&&a(o.status)},o.onprogress=function(e){e.lengthComputable&&(s.dataProgress=e.loaded/e.total,n())},o.open("GET",e,!0),o.send(null)}},LoziObject=function(e,t){function r(t,r){if(r&&t&&t.meshGeometryID){var a=Lozi.Object.getObjectByProperty(e.assets.meshes,"id",t.meshGeometryID);if(r.clips&&r.clips.length>0&&a.skin&&a.skin.bones&&a.skin.bones.length>0){for(var s=new THREE.AnimationMixer(t),n=0;n<r.clips.length;n++)if(r.clips[n]){var o=Lozi.Animation.generateSkinAnimationClip(r.clips[n],t,a.skin.bones);s.clipAction(o,t)}t.mixer=s,p.push(s)}}}function a(){if(e.assets.animations&&e.assets.animations.skin&&e.assets.animations.skin.length>0&&g)for(var t=0;t<g.length;t++)if(g[t].animationID){var a=Lozi.Object.getObjectByProperty(e.assets.animations.skin,"id",g[t].animationID);a&&r(g[t],a)}}function s(t,r){if(t){var a=r?Lozi.Object.generateObject(t,e):c;if(a){if(t.id&&(a.loziID=t.id),t.name&&(a.name=t.name),t.meshID&&(a.meshGeometryID=t.meshID),t.animationID&&(a.animationID=t.animationID),t.lightData&&Lozi.Light.setLightData(a,t.lightData),t.cameraData&&Lozi.Camera.setCameraData(a,t.cameraData),t.transform&&(t.transform.position&&(a.position.order="ZYX",a.position.set(t.transform.position[0],t.transform.position[1],t.transform.position[2])),t.transform.rotation&&(t.cameraData&&(t.transform.rotation[0]=t.transform.rotation[0]-180),a.rotation.order="ZYX",a.rotation.set(Lozi.Math.radians(t.transform.rotation[0]),Lozi.Math.radians(t.transform.rotation[1]),Lozi.Math.radians(t.transform.rotation[2]))),t.transform.scale&&a.scale.set(t.transform.scale[0],t.transform.scale[1],t.transform.scale[2])),a.geometry&&(a.castShadow=a.geometry.castShadow,a.receiveShadow=a.geometry.receiveShadow),t.children&&t.children.length>0)for(var n=0;n<t.children.length;n++)s(t.children[n],a);r&&r.add(a),g.push(a),(t.type==Lozi.Object.types.SpotLight||t.type==Lozi.Object.types.DirectionalLight||t.type==Lozi.Object.types.PointLight||t.type==Lozi.Object.types.AreaLight)&&h.push(a),(t.type==Lozi.Object.types.OrthographicCamera||t.type==Lozi.Object.types.PerspectiveCamera)&&l.push(a)}}}function n(){e&&e.objects&&s(e.objects,null)}function o(){n(),a()}var i,c=this,g=[],p=[],h=[],l=[];t&&t.call(c),o(),LoziObject.prototype.setActiveCamera=function(e){l&&e<l.length&&(i=l[e])},LoziObject.prototype.activeCamera=function(e){return i||l&&l.length>0&&(i=l[0]),i},LoziObject.prototype.flip=function(t,r,a){if(t=t?t:!1,r=r?r:!1,a=a?a:!1,e.generatedAssets&&e.generatedAssets.materials)for(var s=0;s<e.generatedAssets.materials.length;s++)e.generatedAssets.materials[s].side=THREE.FrontSide;if(1==t){c.scale.x=-c.scale.x;for(var s=0;s<l.length;s++)l[s].scale.x=-l[s].scale.x}if(1==r){c.scale.y=-c.scale.y;for(var s=0;s<l.length;s++)l[s].scale.y=-l[s].scale.y}if(1==a){c.scale.z=-c.scale.z;for(var s=0;s<l.length;s++)l[s].scale.z=-l[s].scale.z}if((1==t||1==r||1==a)&&e.generatedAssets&&e.generatedAssets.materials)for(var s=0;s<e.generatedAssets.materials.length;s++)e.generatedAssets.materials[s].side=THREE.BackSide},LoziObject.prototype.setScale=function(e,t,r){e&&(c.scale.x=c.scale.x<0?-e:e),t&&(c.scale.y=c.scale.y<0?-t:t),r&&(c.scale.z=c.scale.z<0?-r:r)},LoziObject.prototype.updateAnimations=function(e){for(var t=0;t<p.length;t++)p[t].update(e)},LoziObject.prototype.euler=function(e,t,r){c.rotation.set(Lozi.Math.radians(e),Lozi.Math.radians(t),Lozi.Math.radians(r))},LoziObject.prototype.objects=function(){return g},LoziObject.prototype.geometries=function(){return e.generatedAssets.geometries},LoziObject.prototype.data=function(){return e},LoziObject.prototype.images=function(){return e.generatedAssets.images},LoziObject.prototype.textures=function(){return e.generatedAssets.textures},LoziObject.prototype.materials=function(){return e.generatedAssets.materials},LoziObject.prototype.lights=function(){return h},LoziObject.prototype.cameras=function(){return l},LoziObject.prototype.animations=function(){return p},LoziObject.prototype.geometryByID=function(t){return Lozi.Geometry.getGeometryByID(t,e)}};